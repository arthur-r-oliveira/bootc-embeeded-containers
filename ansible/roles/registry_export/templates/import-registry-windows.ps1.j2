# PowerShell script to import registry on Windows
# Generated by Ansible Bootc Registry Export

param(
    [string]$RegistryDataPath = "C:\registry-data",
    [string]$RegistryPort = "5000",
    [string]$ContainerName = "local-registry"
)

Write-Host "Bootc Registry Import for Windows" -ForegroundColor Green
Write-Host "=================================" -ForegroundColor Green

# Check if Podman is installed
try {
    $podmanVersion = podman --version
    Write-Host "Podman found: $podmanVersion" -ForegroundColor Green
} catch {
    Write-Host "Podman not found. Please install Podman Desktop first." -ForegroundColor Red
    Write-Host "Download from: https://podman-desktop.io/" -ForegroundColor Yellow
    exit 1
}

# Create registry data directory
if (-not (Test-Path $RegistryDataPath)) {
    New-Item -ItemType Directory -Path $RegistryDataPath -Force
    Write-Host "Created registry data directory: $RegistryDataPath" -ForegroundColor Green
}

# Extract registry data
if (Test-Path "registry-data.tar.gz") {
    Write-Host "Extracting registry data..." -ForegroundColor Yellow
    tar -xzf registry-data.tar.gz -C $RegistryDataPath
    Write-Host "Registry data extracted successfully" -ForegroundColor Green
} else {
    Write-Host "registry-data.tar.gz not found in current directory" -ForegroundColor Red
    exit 1
}

# Stop existing registry container if running
Write-Host "Stopping existing registry container..." -ForegroundColor Yellow
podman stop $ContainerName 2>$null
podman rm $ContainerName 2>$null

# Start registry container
Write-Host "Starting registry container..." -ForegroundColor Yellow
podman run -d --name $ContainerName -p ${RegistryPort}:5000 -v "${RegistryDataPath}:/var/lib/registry" registry:2

if ($LASTEXITCODE -eq 0) {
    Write-Host "Registry container started successfully" -ForegroundColor Green
    Write-Host "Registry URL: http://localhost:$RegistryPort" -ForegroundColor Cyan
    Write-Host "Container name: $ContainerName" -ForegroundColor Cyan
} else {
    Write-Host "Failed to start registry container" -ForegroundColor Red
    exit 1
}

# Wait for registry to be ready
Write-Host "Waiting for registry to be ready..." -ForegroundColor Yellow
Start-Sleep -Seconds 10

# Test registry connectivity
try {
    $response = Invoke-WebRequest -Uri "http://localhost:$RegistryPort/v2/" -Method GET
    if ($response.StatusCode -eq 200) {
        Write-Host "Registry is ready and responding" -ForegroundColor Green
    }
} catch {
    Write-Host "Registry is not responding. Check container logs." -ForegroundColor Red
    podman logs $ContainerName
}

Write-Host "Registry import completed!" -ForegroundColor Green
Write-Host "You can now use the registry at http://localhost:$RegistryPort" -ForegroundColor Cyan