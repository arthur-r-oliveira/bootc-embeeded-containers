#!/bin/bash
# Linux script to import registry
# Generated by Ansible Bootc Registry Export

set -euo pipefail

# Configuration
REGISTRY_DATA_PATH="${REGISTRY_DATA_PATH:-/var/lib/registry}"
REGISTRY_PORT="${REGISTRY_PORT:-5000}"
CONTAINER_NAME="${CONTAINER_NAME:-local-registry}"

echo "Bootc Registry Import for Linux"
echo "==============================="

# Check if podman is installed
if ! command -v podman &> /dev/null; then
    echo "Podman not found. Please install podman first."
    echo "On RHEL/Fedora: sudo dnf install podman"
    exit 1
fi

echo "Podman found: $(podman --version)"

# Create registry data directory
if [ ! -d "$REGISTRY_DATA_PATH" ]; then
    sudo mkdir -p "$REGISTRY_DATA_PATH"
    echo "Created registry data directory: $REGISTRY_DATA_PATH"
fi

# Extract registry data
if [ -f "registry-data.tar.gz" ]; then
    echo "Extracting registry data..."
    sudo tar -xzf registry-data.tar.gz -C "$REGISTRY_DATA_PATH"
    echo "Registry data extracted successfully"
else
    echo "registry-data.tar.gz not found in current directory"
    exit 1
fi

# Stop existing registry container if running
echo "Stopping existing registry container..."
sudo podman stop "$CONTAINER_NAME" 2>/dev/null || true
sudo podman rm "$CONTAINER_NAME" 2>/dev/null || true

# Start registry container
echo "Starting registry container..."
sudo podman run -d --name "$CONTAINER_NAME" -p "${REGISTRY_PORT}:5000" -v "${REGISTRY_DATA_PATH}:/var/lib/registry" registry:2

if [ $? -eq 0 ]; then
    echo "Registry container started successfully"
    echo "Registry URL: http://localhost:$REGISTRY_PORT"
    echo "Container name: $CONTAINER_NAME"
else
    echo "Failed to start registry container"
    exit 1
fi

# Wait for registry to be ready
echo "Waiting for registry to be ready..."
sleep 10

# Test registry connectivity
if curl -s "http://localhost:$REGISTRY_PORT/v2/" > /dev/null; then
    echo "Registry is ready and responding"
else
    echo "Registry is not responding. Check container logs."
    sudo podman logs "$CONTAINER_NAME"
    exit 1
fi

echo "Registry import completed!"
echo "You can now use the registry at http://localhost:$REGISTRY_PORT"